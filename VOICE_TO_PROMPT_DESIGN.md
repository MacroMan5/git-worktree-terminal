# Voice-to-Prompt Feature Design

This document outlines the architecture, technology stack, and workflow for integrating a voice-driven prompt engineering layer into `tmuxlike`, powered by a modular Python backend (based on `JARVIS_VoiceAssistant`).

## 1. Vision & Core Objective
To provide a **Push-to-Talk (PTT)** experience where a developer can speak messy, natural language instructions and have them instantly transformed into clean, professional, and well-organized prompts or CLI commands, which are then automatically typed into the active terminal pane.

---

## 2. Architecture: "The Voice Bridge"

The system uses a **Sidecar Backend** architecture to bridge the C# (WPF) frontend with the Python (AI/ML) backend.

### Components:
*   **Frontend (`tmuxlike` - C# WPF):**
    *   Manages the UI and terminal panes.
    *   Detects the PTT key (e.g., `Right Ctrl` or `Alt+V`).
    *   Displays the optional "Confirmation & Edit" overlay.
    *   Injects final text into the active `TermPTY` session.
*   **Backend (`voice-bridge` - Python):**
    *   A lightweight version of the `JARVIS_VoiceAssistant` core.
    *   Handles local audio capture and transcription (Whisper).
    *   Performs prompt refinement using a local or API-based LLM.
*   **Communication Layer:**
    *   **WebSocket Server:** High-speed, bidirectional communication on `ws://localhost:5005`.
    *   **Protocol:** JSON-based event streaming.

---

## 3. Technology Stack

### Transcription (Speech-to-Text)
*   **Engine:** `RealtimeSTT` (based on Faster-Whisper).
*   **Mode:** Local, GPU-accelerated (CUDA).
*   **Performance:** Aiming for < 500ms transcription latency.

### Refinement (The "Brain")
*   **Local LLM (Recommended):** **Qwen2.5-Coder-7B** (via Ollama or `llama-cpp-python`).
    *   *Why:* Exceptional instruction following and CLI/Git context awareness.
*   **API Fallback:** Google Gemini 1.5 Flash or OpenAI GPT-4o-mini.
*   **Strategy:** A dedicated system prompt transforms messy transcripts into "Clean Developer Prompts."

---

## 4. The Workflow

| Phase | Action | Detail |
| :--- | :--- | :--- |
| **1. Trigger** | Hold PTT Key | `tmuxlike` sends `START_RECORDING` to Python. Status bar: ðŸŽ™ï¸ **Listening...** |
| **2. Capture** | User Speaks | Python backend streams audio to Whisper. |
| **3. Release** | Release PTT Key | `tmuxlike` sends `STOP_RECORDING`. Status bar: ðŸ”„ **Refining...** |
| **4. Process** | LLM Refinement | Qwen/API cleans the transcript: *"Fix the bug in the auth"* -> `git diff src/auth.cs` |
| **5. Deliver** | WebSocket Push | Python sends `{"event": "INJECT", "text": "..."}` to C#. |
| **6. Output** | Injection | Text is typed into the focused terminal. |

---

## 5. UI/UX Design

### Confirmation Mode (Optional)
When enabled, the prompt doesn't go straight to the terminal. Instead:
1.  A **Z-Indexed Overlay** slides up from the bottom of the window.
2.  A `TextBox` contains the refined prompt, allowing for manual edits.
3.  **Enter** = Inject into Terminal.
4.  **Esc** = Discard.

### Silent Mode (Direct Injection)
The prompt is typed instantly. This is the "Zero-Click" experience for power users.

---

## 6. Communication Protocol (JSON)

**C# to Python:**
*   `{"action": "PTT_DOWN"}`: Start recording.
*   `{"action": "PTT_UP"}`: Stop and process.
*   `{"action": "SET_PROVIDER", "value": "LOCAL|API"}`: Switch LLM backend.

**Python to C#:**
*   `{"event": "LISTENING"}`: Confirming mic is active.
*   `{"event": "TRANSCRIPT", "text": "..."}`: Real-time preview (optional).
*   `{"event": "FINAL_PROMPT", "text": "..."}`: The optimized output ready for injection.

---

## 7. Future Implementation Steps

1.  **Phase 1 (Python):** Create `voice_bridge.py` using `RealtimeSTT` and an Ollama connector for Qwen2.5.
2.  **Phase 2 (C#):** Implement `VoiceService.cs` (WebSocket client) and PTT key hooks.
3.  **Phase 3 (UI):** Add the `PromptOverlay.xaml` for confirmation mode.
4.  **Phase 4 (Integration):** Connect the `VoiceService` to the `MainWindow`'s `_currentWorktree.Panes[_focusedPaneIndex].Session`.

---
*Generated by Gemini CLI - 2026-02-17*
